name: '‚úã GameLife - Continuous Delivery'

on:
  workflow_dispatch:
    inputs:
      actions:
        description: 'Choose platform to build'
        required: true
        default: 'both'
        type: choice
        options:
        - both
        - android
        - ios
      environment:
        description: 'Choose environment to deploy'
        required: true
        default: 'prod'
        type: choice
        options:
        - dev
        - test
        - prod
      delivery:
        description: 'Delivery to stores (only for test & prod)'
        required: true
        default: false
        type: boolean
      save-apk-artifact:
        description: 'Download apk artifact (only for android)'
        required: false
        default: false
        type: boolean

jobs:
  tests:
    name: 'üîç Tests'
    uses: ./.github/workflows/step-tests.yml
    with:
      environment: ${{ github.event.inputs.environment }}
      test-client: true
      test-database: true
      test-migration: true

  android:
    name: 'ü§ñ Android'
    if: github.event.inputs.actions == 'both' || github.event.inputs.actions == 'android'
    needs: tests
    uses: ./.github/workflows/step-android.yml
    with:
      environment: ${{ github.event.inputs.environment }}
      delivery: ${{ github.event.inputs.delivery }}
      save-apk-artifact: ${{ github.event.inputs.save-apk-artifact }}

  ios:
    name: 'üçè iOS'
    if: github.event.inputs.actions == 'both' || github.event.inputs.actions == 'android'
    needs: tests
    uses: ./.github/workflows/step-ios.yml
    with:
      environment: ${{ github.event.inputs.environment }}
      delivery: ${{ github.event.inputs.delivery }}

  enable-test-account:
    name: 'üîë Enable test account'
    if: success() || failure()
    runs-on: ubuntu-latest
    needs: [ android, ios ]
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Install PHP with mysqli extension'
        run: sudo apt-get update && sudo apt-get install php php-mysqli -y

      - name: 'Enable test account'
        run: |
          php ./Tools/Maintenance/setTestAccount.php \
          '${{ vars.DB_PROD_HOST }}' \
          '${{ vars.DB_PROD_USER }}' \
          '${{ secrets.DB_PROD_PASS }}' \
          '${{ vars.DB_PROD_NAME }}' \
          1

  notify:
    name: 'üì£ App Published'
    runs-on: ubuntu-latest
    needs: enable-test-account
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Install PHP with mysqli extension'
        run: sudo apt-get update && sudo apt-get install php php-mysqli -y

      - name: 'Get app version & delivery status'
        run: |
          GL_VERSION=$( \
            php ./Tools/Maintenance/getVersion.php \
            '${{ vars.DB_TEST_HOST }}' \
            '${{ vars.DB_TEST_USER }}' \
            '${{ secrets.DB_TEST_PASS }}' \
            '${{ vars.DB_TEST_NAME }}' \
          )

          echo "Version: $GL_VERSION"
          echo "GL_VERSION=$GL_VERSION" >> $GITHUB_ENV

          if [[ "$APPSTORE_STATUS" == "success" && "$PLAYSTORE_STATUS" == "success" ]]; then
            echo "NOTIFICATION_TEXT=GameLife v$GL_VERSION a √©t√© envoy√©e sur le PlayStore ü§ñ et l'AppStore üçè avec succ√®s üéâ"
          elif [[ "$APPSTORE_STATUS" == "success" && "$PLAYSTORE_STATUS" == "failure" ]]; then
            echo "NOTIFICATION_TEXT=GameLife v$GL_VERSION a √©t√© envoy√©e sur l'AppStore üçè avec succ√®s üéâ"
          elif [[ "$APPSTORE_STATUS" == "failure" && "$PLAYSTORE_STATUS" == "success" ]]; then
            echo "NOTIFICATION_TEXT=GameLife v$GL_VERSION a √©t√© envoy√©e sur le PlayStore ü§ñ avec succ√®s üéâ"
          elif [[ "$APPSTORE_STATUS" == "failure" || "$PLAYSTORE_STATUS" == "failure" ]]; then
            echo "NOTIFICATION_TEXT=GameLife v$GL_VERSION n'a pas pu √™tre envoy√©e sur le PlayStore ü§ñ ou l'AppStore üçè"
          else
            echo "NOTIFICATION_TEXT=GameLife v$GL_VERSION n'a pas pu √™tre envoy√©e"
          fi

      - name: 'Send notification to Discord'
        env:
          GL_VERSION: ${{ env.GL_VERSION }}
          NOTIFICATION_TEXT: ${{ env.NOTIFICATION_TEXT }}
          NEXT_WORKFLOW_URL: 'https://github.com/OxyFoo/GameLife/actions/workflows/prod-deploy.yml'
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl \
            -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\":\"$NOTIFICATION_TEXT\",\"embeds\":[{\"title\":\"Workflow\",\"url\":\"$NEXT_WORKFLOW_URL\",\"color\":16711680,\"fields\":[{\"name\":\"Version\",\"value\":\"$GL_VERSION\",\"inline\":true}]}]}" \
            $DISCORD_WEBHOOK_URL
