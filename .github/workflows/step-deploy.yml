name: 'üß© Server tests'

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to test (test or prod)'
        required: true
        type: string
      actions:
        description: 'Choose actions to do (deploy, migration or both)'
        required: false
        type: string
        default: 'both'

jobs:
  enable-maintenance:
    name: 'üöß Enable Maintenance'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Install PHP with mysqli extension'
        run: sudo apt-get update && sudo apt-get install php php-mysqli -y

      - name: 'Enable maintenance mode - test'
        if: ${{ github.event.inputs.environment == 'test' }}
        run: |
          php ./Tools/Maintenance/setMaintenance.php \
            '${{ vars.DB_TEST_HOST }}' \
            '${{ vars.DB_TEST_USER }}' \
            '${{ secrets.DB_TEST_PASS }}' \
            '${{ vars.DB_TEST_NAME }}' \
            1

      - name: 'Enable maintenance mode - prod'
        if: ${{ github.event.inputs.environment == 'prod' }}
        run: |
          php ./Tools/Maintenance/setMaintenance.php \
            '${{ vars.DB_PROD_HOST }}' \
            '${{ vars.DB_PROD_USER }}' \
            '${{ secrets.DB_PROD_PASS }}' \
            '${{ vars.DB_PROD_NAME }}' \
            1

  deploy:
    name: 'üîÅ Update server codebase'
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.actions == 'both' || github.event.inputs.actions == 'deploy' }}
    needs: enable-maintenance
    env:
      ARCHIVE: archive_code_$(date +'%Y-%m-%d_%H-%M-%S').tar.gz
      DB_HOST: ${{ github.event.inputs.environment == 'test' && secrets.FTP_TEST_HOST || secrets.FTP_PROD_HOST }}
      DB_USER: ${{ github.event.inputs.environment == 'test' && secrets.FTP_TEST_USER || secrets.FTP_PROD_USER }}
      DB_PASS: ${{ github.event.inputs.environment == 'test' && secrets.FTP_TEST_PASS || secrets.FTP_PROD_PASS }}
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Install FTP client'
        run: sudo apt-get update && sudo apt-get install lftp tar -y

      - name: 'Create temporary directory'
        run: mkdir -p ftp_backup

      - name: 'Download files from FTP prod server'
        run: |
          lftp -c "set ftp:ssl-allow true; set ssl:verify-certificate no;
          open -u $DB_USER,$DB_PASS $DB_HOST;
          mirror --exclude=backups/ / ftp_backup/"

      - name: 'Archive downloaded files'
        run: tar -czf $ARCHIVE -C ftp_backup .

      - name: 'Upload archive to FTP prod server'
        run: |
          lftp -c "set ftp:ssl-allow true; set ssl:verify-certificate no;
          open -u $DB_USER,$DB_PASS $DB_HOST;
          put -O ./backups/ $ARCHIVE"

      - name: 'Upload files to FTP prod server'
        run: |
          lftp -c "set ftp:ssl-allow true; set ssl:verify-certificate no;
          open -u $DB_USER,$DB_PASS $DB_HOST;
          mirror --reverse ./src/Server/HTTP/ /"

  migration:
    name: 'üöö Database migration'
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.actions == 'both' || github.event.inputs.actions == 'migration' }}
    needs: enable-maintenance
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Install PHP with mysqli extension'
        run: sudo apt-get update && sudo apt-get install php php-mysqli -y

      - name: 'Run migration - prod'
        if: ${{ github.event.inputs.environment == 'prod' }}
        run: |
          php ./Tools/TableFusion/index.php \
          '${{ vars.DB_TEST_HOST }}' \
          '${{ vars.DB_TEST_USER }}' \
          '${{ secrets.DB_TEST_PASS }}' \
          '${{ vars.DB_TEST_NAME }}' \
          '${{ vars.DB_PROD_HOST }}' \
          '${{ vars.DB_PROD_USER }}' \
          '${{ secrets.DB_PROD_PASS }}' \
          '${{ vars.DB_PROD_NAME }}' \
          --no-confirm

      - name: 'Run migration - test'
        if: ${{ github.event.inputs.environment == 'test' }}
        run: |
          php ./Tools/TableFusion/index.php \
          '${{ vars.DB_DEV_HOST }}' \
          '${{ vars.DB_DEV_USER }}' \
          '${{ secrets.DB_DEV_PASS }}' \
          '${{ vars.DB_DEV_NAME }}' \
          '${{ vars.DB_TEST_HOST }}' \
          '${{ vars.DB_TEST_USER }}' \
          '${{ secrets.DB_TEST_PASS }}' \
          '${{ vars.DB_TEST_NAME }}' \
          --no-confirm

  disable-maintenance:
    name: 'üöß Disable Maintenance'
    runs-on: ubuntu-latest
    needs: [ deploy, migration ]
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Install PHP with mysqli extension'
        run: sudo apt-get update && sudo apt-get install php php-mysqli -y

      - name: 'Disable maintenance mode - test'
        run: |
          php ./Tools/Maintenance/setMaintenance.php \
            '${{ vars.DB_TEST_HOST }}' \
            '${{ vars.DB_TEST_USER }}' \
            '${{ secrets.DB_TEST_PASS }}' \
            '${{ vars.DB_TEST_NAME }}' \
            0

      - name: 'Disable maintenance mode - prod'
        run: |
          php ./Tools/Maintenance/setMaintenance.php \
            '${{ vars.DB_PROD_HOST }}' \
            '${{ vars.DB_PROD_USER }}' \
            '${{ secrets.DB_PROD_PASS }}' \
            '${{ vars.DB_PROD_NAME }}' \
            0
